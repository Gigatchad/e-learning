image: node:20

stages:
  - test
  - build

# Cache modules in between jobs
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - node_modules/
    - frontend/node_modules/

# Backend Tests
backend_tests:
  stage: test
  script:
    - echo "Installing backend dependencies..."
    - npm install
    - echo "Running backend tests..."
    - npm test
  variables:
    # Set environment variables for testing
    NODE_ENV: "test"
    # Mock secrets since we are using mocks in tests anyway, but these suppress startup warnings
    JWT_SECRET: "ci_jwt_secret"
    JWT_REFRESH_SECRET: "ci_refresh_secret"

# Integration Tests
integration_tests:
  stage: test
  script:
    - echo "Running full application integration tests..."
    - npm test tests/integration.test.js
  variables:
    NODE_ENV: "test"
    JWT_SECRET: "ci_jwt_secret"

# Load Test (Smoke test version)
load_test:
  stage: test
  script:
    - echo "Running backend in background..."
    - npm start & 
    - sleep 10 # Wait for server to start
    - echo "Running smoke load test..."
    - npx artillery run tests/load-test.yml
  allow_failure: true

# Frontend Build Test (Ensures frontend compiles)
frontend_build:
  stage: build
  script:
    - echo "Installing frontend dependencies..."
    - cd frontend
    - npm install
    - echo "Building frontend..."
    - npm run build
  artifacts:
    paths:
      - frontend/dist
    expire_in: 1 hour
